<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Available Dates - Excelsior Cleaning</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.css' rel='stylesheet' />
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.js'></script>
    <style>
        body { padding: 20px; }
        #calendar { margin-top: 20px; }
        .date-list { max-height: 300px; overflow-y: auto; }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="mb-4">Manage Available Dates</h1>
        
        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Add Available Dates</h5>
                        <div class="mb-3">
                            <label for="adminKey" class="form-label">Admin Key</label>
                            <input type="password" class="form-control" id="adminKey" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Select Dates</label>
                            <div id="calendar"></div>
                        </div>
                        <button onclick="addDates()" class="btn btn-primary">Add Selected Dates</button>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Current Available Dates</h5>
                        <div class="date-list" id="dateList">
                            Loading...
                        </div>
                        <button onclick="refreshDates()" class="btn btn-secondary mt-3">Refresh List</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let calendar;
        let selectedDates = new Set();

        document.addEventListener('DOMContentLoaded', function() {
            const calendarEl = document.getElementById('calendar');
            calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                selectable: true,
                select: function(info) {
                    const dateStr = info.startStr;
                    if (selectedDates.has(dateStr)) {
                        selectedDates.delete(dateStr);
                        calendar.unselect();
                    } else {
                        selectedDates.add(dateStr);
                    }
                    refreshCalendar();
                }
            });
            calendar.render();
            refreshDates();
        });

        function refreshCalendar() {
            calendar.removeAllEvents();
            selectedDates.forEach(date => {
                calendar.addEvent({
                    start: date,
                    display: 'background',
                    backgroundColor: '#007bff'
                });
            });
        }

        async function addDates() {
            const adminKey = document.getElementById('adminKey').value;
            if (!adminKey) {
                alert('Please enter the admin key');
                return;
            }

            try {
                const response = await fetch('/.netlify/functions/manage-dates', {
                    method: 'POST',
                    body: JSON.stringify({
                        action: 'add',
                        dates: Array.from(selectedDates),
                        adminKey: adminKey
                    })
                });

                const result = await response.json();
                if (response.ok) {
                    alert('Dates added successfully');
                    selectedDates.clear();
                    refreshCalendar();
                    refreshDates();
                } else {
                    alert(result.error || 'Failed to add dates');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Failed to add dates');
            }
        }

        async function refreshDates() {
            const adminKey = document.getElementById('adminKey').value;
            if (!adminKey) {
                alert('Please enter the admin key');
                return;
            }

            try {
                const response = await fetch('/.netlify/functions/manage-dates', {
                    method: 'POST',
                    body: JSON.stringify({
                        action: 'list',
                        dates: [],
                        adminKey: adminKey
                    })
                });

                const result = await response.json();
                if (response.ok) {
                    const dateList = document.getElementById('dateList');
                    if (result.dates && result.dates.length > 0) {
                        const dates = result.dates.map(d => d.date).sort();
                        dateList.innerHTML = '<ul class="list-group">' + 
                            dates.map(date => `
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    ${date}
                                    <button class="btn btn-danger btn-sm" onclick="removeDate('${date}')">Remove</button>
                                </li>
                            `).join('') + 
                            '</ul>';
                    } else {
                        dateList.innerHTML = '<p>No available dates found</p>';
                    }
                } else {
                    dateList.innerHTML = '<p class="text-danger">Error: ' + (result.error || 'Failed to fetch dates') + '</p>';
                }
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('dateList').innerHTML = '<p class="text-danger">Failed to fetch dates</p>';
            }
        }

        async function removeDate(date) {
            const adminKey = document.getElementById('adminKey').value;
            if (!adminKey) {
                alert('Please enter the admin key');
                return;
            }

            if (confirm(`Are you sure you want to remove ${date}?`)) {
                try {
                    const response = await fetch('/.netlify/functions/manage-dates', {
                        method: 'POST',
                        body: JSON.stringify({
                            action: 'remove',
                            dates: [date],
                            adminKey: adminKey
                        })
                    });

                    const result = await response.json();
                    if (response.ok) {
                        alert('Date removed successfully');
                        refreshDates();
                    } else {
                        alert(result.error || 'Failed to remove date');
                    }
                } catch (error) {
                    console.error('Error:', error);
                    alert('Failed to remove date');
                }
            }
        }
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Available Dates - Excelsior Cleaning</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.css' rel='stylesheet' />
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.js'></script>
    <style>
        body { padding: 20px; }
        #calendar { margin-top: 20px; }
        .date-list { max-height: 300px; overflow-y: auto; }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="mb-4">Manage Available Dates</h1>
        
        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Add Available Dates</h5>
                        <div class="mb-3">
                            <label class="form-label">Select Dates</label>
                            <div id="calendar"></div>
                        </div>
                        <div class="bulk-actions mt-4 mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="selectAllMonth">
                                <label class="form-check-label" for="selectAllMonth">
                                    Seleccionar Todo el Mes
                                </label>
                            </div>
                        </div>
                        <button onclick="addDates()" class="btn btn-primary">Add Selected Dates</button>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Current Available Dates</h5>
                        <div class="date-list" id="dateList">
                            Loading...
                        </div>
                        <button onclick="refreshDates()" class="btn btn-secondary mt-3">Refresh List</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let calendar;
        let selectedDates = new Set();

        function showMessage(message, isError = false) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${isError ? 'danger' : 'success'} alert-dismissible fade show`;
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            `;
            document.querySelector('.container').insertBefore(alertDiv, document.querySelector('.row'));
            
            // Auto dismiss after 5 seconds
            setTimeout(() => {
                alertDiv.remove();
            }, 5000);
        }

        document.addEventListener('DOMContentLoaded', function() {
            const calendarEl = document.getElementById('calendar');
            calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                selectable: true,
                select: function(info) {
                    const dateStr = info.startStr;
                    if (selectedDates.has(dateStr)) {
                        selectedDates.delete(dateStr);
                        calendar.unselect();
                    } else {
                        selectedDates.add(dateStr);
                    }
                    refreshCalendar();
                }
            });
            calendar.render();
            refreshDates();
        });

        function refreshCalendar() {
            calendar.removeAllEvents();
            selectedDates.forEach(date => {
                calendar.addEvent({
                    start: date,
                    display: 'background',
                    backgroundColor: '#007bff'
                });
            });
        }

        async function addDates() {
            try {
                const response = await fetch('/.netlify/functions/manage-dates', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        action: 'add',
                        dates: Array.from(selectedDates)
                    })
                });

                const result = await response.json();
                if (response.ok) {
                    showMessage('Dates added successfully');
                    selectedDates.clear();
                    refreshCalendar();
                    updateDateList(result.dates);
                } else {
                    showMessage(result.error || 'Failed to add dates', true);
                    console.error('Error details:', result);
                }
            } catch (error) {
                console.error('Error:', error);
                showMessage('Failed to add dates: ' + error.message, true);
            }
        }

        async function refreshDates() {
            try {
                const response = await fetch('/.netlify/functions/manage-dates', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        action: 'list',
                        dates: []
                    })
                });

                const result = await response.json();
                if (response.ok) {
                    updateDateList(result.dates);
                } else {
                    document.getElementById('dateList').innerHTML = '<p class="text-danger">Error: ' + (result.error || 'Failed to fetch dates') + '</p>';
                    console.error('Error details:', result);
                }
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('dateList').innerHTML = '<p class="text-danger">Failed to fetch dates: ' + error.message + '</p>';
            }
        }

        function updateDateList(dates) {
            const dateList = document.getElementById('dateList');
            if (dates && dates.length > 0) {
                const sortedDates = dates.map(d => d.date || d).sort();
                dateList.innerHTML = '<ul class="list-group">' + 
                    sortedDates.map(date => `
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            ${date}
                            <button class="btn btn-danger btn-sm" onclick="removeDate('${date}')">Remove</button>
                        </li>
                    `).join('') + 
                    '</ul>';
            } else {
                dateList.innerHTML = '<p class="text-muted">No available dates found</p>';
            }
        }

        async function removeDate(date) {
            if (confirm(`Are you sure you want to remove ${date}?`)) {
                try {
                    const response = await fetch('/.netlify/functions/manage-dates', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            action: 'remove',
                            dates: [date]
                        })
                    });

                    const result = await response.json();
                    if (response.ok) {
                        showMessage('Date removed successfully');
                        updateDateList(result.dates);
                    } else {
                        showMessage(result.error || 'Failed to remove date', true);
                        console.error('Error details:', result);
                    }
                } catch (error) {
                    console.error('Error:', error);
                    showMessage('Failed to remove date: ' + error.message, true);
                }
            }
        }
    </script>
</body>
</html>
